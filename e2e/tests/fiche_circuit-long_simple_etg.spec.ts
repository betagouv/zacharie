import { test, expect } from "@playwright/test";
import { resetDb } from "../scripts/reset-db";
import { connectWith } from "../utils/connect-with";
import { NETWORK_PRESETS } from "../utils/network-throttling";

test.describe("Fiches ETG", () => {
  test.beforeEach(async () => {
    await resetDb("ETG");
  });

  test("Pas de stockage - Je renvoie au SVI", async ({ page, context }) => {
    // const cdpSession = await context.newCDPSession(page);
    // // @ts-ignore
    // await cdpSession.send("Network.emulateNetworkConditions", NETWORK_PRESETS.PrettyGood);

    const feiId = "ZACH-20250707-QZ6E0-165242";
    await connectWith(page, "etg-1@example.fr");
    await expect(page).toHaveURL("http://localhost:3290/app/tableau-de-bord");
    await expect(page.getByText("Synchronisation en cours")).toBeVisible();
    await expect(page.getByText("Synchronisation en cours")).not.toBeVisible();
    await expect(page.getByRole("link", { name: feiId })).toBeVisible();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - link /ZACH-\\d+-QZ6E0-\\d+ √Ä compl√©ter \\d+\\/\\d+\\/\\d+ chassenard √Ä renseigner 4 daims fin de liste fin de liste ZACH-\\d+-QZ6E0-\\d+/:
        - /url: /app/tableau-de-bord/fei/ZACH-20250707-QZ6E0-165242
        - paragraph: √Ä compl√©ter
        - img
        - paragraph: chassenard
        - img
        - paragraph: √Ä renseigner
        - img
        - paragraph: 4 daims
        - paragraph: fin de liste
        - paragraph: fin de liste
      `);
    await page.getByRole("link", { name: feiId }).click();
    await page.locator("summary").filter({ hasText: "Donn√©es de chasse" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - group:
        - heading "Donn√©es de chasse" [level=3]
        - paragraph: Esp√®ces
        - paragraph: Daim, Pigeons
        - paragraph: √âpisodes cl√©s
        - list:
          - listitem:
            - paragraph: "/Commune de mise √† mort : \\\\d+ CHASSENARD/"
          - listitem:
            - paragraph: "/Date de mise √† mort : lundi 7 juillet \\\\d+/"
          - listitem:
            - paragraph: "/Heure de mise √† mort de la premi√®re carcasse de la fiche : \\\\d+:\\\\d+/"
        - paragraph: Acteurs
        - paragraph: Examinateur Initial
        - list:
          - listitem:
            - paragraph: Marie Martin
          - listitem:
            - paragraph: /\\d+/
          - listitem:
            - paragraph: examinateur@example.fr
          - listitem:
            - paragraph: /CFEI-\\d+-\\d+-\\d+/
          - listitem:
            - paragraph: /\\d+ Paris/
        - paragraph: Premier D√©tenteur
        - list:
          - listitem:
            - paragraph: Pierre Petit
          - listitem:
            - paragraph: /\\d+/
          - listitem:
            - paragraph: premier-detenteur@example.fr
          - listitem:
            - paragraph: /\\d+ Paris/
      `);
    await page.getByRole("heading", { name: "ü´µ Cette fiche vous a √©t√©" }).click();
    await expect(page.getByText("√âtape 2 sur")).toBeVisible();
    await expect(page.getByRole("heading", { name: "Fiche envoy√©e, pas encore" })).toBeVisible();
    await expect(page.getByText("√âtape suivante : Transport")).toBeVisible();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-004 Mise √†" }).click();
    await page.getByRole("listitem").filter({ hasText: "Fermer" }).getByRole("button").click();
    await page.getByRole("button", { name: "Pigeons (10) N¬∞ MM-001-003" }).click();
    await page.getByRole("heading", { name: "Pigeons (10) - N¬∞ MM-001-" }).click();
    await page.getByLabel("Pigeons (10) - N¬∞ MM-001-").getByTitle("Fermer").click();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-002 Mise √†" }).click();
    await expect(page.getByText("Unique - Abc√®s ou nodules")).toBeVisible();
    await page.getByLabel("Daim - N¬∞ MM-001-002").getByTitle("Fermer").click();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-001 Mise √†" }).click();
    await expect(page.getByText("Abc√®s ou nodules Unique -")).toBeVisible();
    await page.getByRole("listitem").filter({ hasText: "Fermer" }).getByRole("button").click();
    await page.getByRole("button", { name: "Je r√©ceptionne le gibier" }).click();
    await expect(page.getByRole("heading", { name: "R√©ception par un √©" })).toBeVisible();
    await expect(page.getByText("√âtape suivante : Inspection")).toBeVisible();
    await page.locator(".cursor-not-allowed").click();
    await expect(
      page.getByText("S√©lection du prochain destinataireProchain d√©tenteur des carcasses *Indiquez")
    ).toBeVisible();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-001 Mise √†" }).click();
    await page.getByText("Anomalies abats:Abc√®s ou").click();
    await page.getByLabel("Daim - N¬∞ MM-001-001Anomalies").getByText("Carcasse accept√©e").click();
    await expect(page.getByRole("button", { name: "Daim N¬∞ MM-001-001 Mise √†" })).toBeVisible();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-002 Mise √†" }).click();
    await page.getByText("Anomalies carcasse:Unique -").click();
    await page.getByLabel("Daim - N¬∞ MM-001-002Anomalies").getByText("Carcasse refus√©e").click();
    await page.getByRole("button", { name: "Viande √† √©volution anormale (" }).click();
    await page.getByRole("textbox", { name: "Votre commentaire Un" }).click();
    await page.getByRole("textbox", { name: "Votre commentaire Un" }).fill("Pas bon");
    await page.getByLabel("Daim - N¬∞ MM-001-002Anomalies").getByRole("button", { name: "Enregistrer" }).click();
    await expect(page.getByRole("button", { name: "Daim N¬∞ MM-001-002 Mise √†" })).toBeVisible();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-004 Mise √†" }).click();
    await page.getByLabel("Daim - N¬∞ MM-001-004").getByText("Carcasse manquante").click();
    await expect(page.getByRole("button", { name: "Daim N¬∞ MM-001-004 Mise √†" })).toBeVisible();
    await expect(page.getByText("Je prends en charge les")).toBeVisible();
    await expect(page.getByText("J'ai refus√© 1 carcasse.")).toBeVisible();
    await expect(page.getByText("J'ai signal√© 1 carcasse")).toBeVisible();
    await page
      .locator("#form_intermediaire_check_finished_at div")
      .filter({ hasText: "Je prends en charge les" })
      .click();
    await page.getByRole("button", { name: "Cliquez ici pour d√©finir" }).click();
    await page.getByRole("button", { name: "Enregistrer" }).click();
    await expect(page.getByText("Il manque le prochain d√©")).toBeVisible();
    await page.getByRole("button", { name: "SVI" }).click();
    await page.getByRole("button", { name: "Envoyer" }).click();
    await expect(page.getByText("SVI 1 a √©t√© notifi√©")).toBeVisible();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - 'button /Daim N¬∞ MM-\\d+-\\d+ Mise √† mort : \\d+\\/\\d+\\/\\d+ 1 anomalie accept√©/':
        - paragraph: Daim
        - paragraph: /N¬∞ MM-\\d+-\\d+/
        - paragraph: "/Mise √† mort : \\\\d+\\\\/\\\\d+\\\\/\\\\d+/"
        - paragraph: 1 anomalie
        - paragraph: accept√©
      `);
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - 'button /Daim N¬∞ MM-\\d+-\\d+ Mise √† mort : \\d+\\/\\d+\\/\\d+ 1 anomalie, 1 commentaire refus√©/':
        - paragraph: Daim
        - paragraph: /N¬∞ MM-\\d+-\\d+/
        - paragraph: "/Mise √† mort : \\\\d+\\\\/\\\\d+\\\\/\\\\d+/"
        - paragraph: 1 anomalie, 1 commentaire
        - paragraph: refus√©
      `);
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - 'button /Daim N¬∞ MM-\\d+-\\d+ Mise √† mort : \\d+\\/\\d+\\/\\d+ Aucune anomalie manquant/':
        - paragraph: Daim
        - paragraph: /N¬∞ MM-\\d+-\\d+/
        - paragraph: "/Mise √† mort : \\\\d+\\\\/\\\\d+\\\\/\\\\d+/"
        - paragraph: Aucune anomalie
        - paragraph: manquant
      `);
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - 'button /Pigeons \\(\\d+\\) N¬∞ MM-\\d+-\\d+ Mise √† mort : \\d+\\/\\d+\\/\\d+ Aucune anomalie en cours de traitement/':
        - paragraph: /Pigeons \\(\\d+\\)/
        - paragraph: /N¬∞ MM-\\d+-\\d+/
        - paragraph: "/Mise √† mort : \\\\d+\\\\/\\\\d+\\\\/\\\\d+/"
        - paragraph: Aucune anomalie
        - paragraph: en cours de traitement
      `);
    await page.getByRole("link", { name: "Voir toutes mes fiches" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - link /ZACH-\\d+-QZ6E0-\\d+ En cours \\d+\\/\\d+\\/\\d+ chassenard √Ä renseigner \\d+ pigeons 3 daims fin de liste 2 carcasses refus√©es Inspection par le SVI ZACH-\\d+-QZ6E0-\\d+/:
        - /url: /app/tableau-de-bord/fei/ZACH-20250707-QZ6E0-165242
        - paragraph: En cours
        - img
        - paragraph: chassenard
        - img
        - paragraph: √Ä renseigner
        - img
        - paragraph: /\\d+ pigeons/
        - paragraph: 3 daims
        - paragraph: fin de liste
        - img
        - paragraph: 2 carcasses refus√©es
        - paragraph: Inspection par le SVI
      `);
  });

  test("Pas de stockage - Je transfert √† un autre collecteur", async ({ page }) => {
    const feiId = "ZACH-20250707-QZ6E0-165242";
    await connectWith(page, "etg-1@example.fr");
    await expect(page).toHaveURL("http://localhost:3290/app/tableau-de-bord");
    await expect(page.getByText("Synchronisation en cours")).toBeVisible();
    await expect(page.getByText("Synchronisation en cours")).not.toBeVisible();
    await expect(page.getByRole("link", { name: feiId })).toBeVisible();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - link /ZACH-\\d+-QZ6E0-\\d+ √Ä compl√©ter \\d+\\/\\d+\\/\\d+ chassenard √Ä renseigner 4 daims fin de liste fin de liste ZACH-\\d+-QZ6E0-\\d+/:
        - /url: /app/tableau-de-bord/fei/ZACH-20250707-QZ6E0-165242
        - paragraph: √Ä compl√©ter
        - img
        - paragraph: chassenard
        - img
        - paragraph: √Ä renseigner
        - img
        - paragraph: 4 daims
        - paragraph: fin de liste
        - paragraph: fin de liste
      `);
    await page.getByRole("link", { name: feiId }).click();
    await page.locator("summary").filter({ hasText: "Donn√©es de chasse" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - group:
        - heading "Donn√©es de chasse" [level=3]
        - paragraph: Esp√®ces
        - paragraph: Daim, Pigeons
        - paragraph: √âpisodes cl√©s
        - list:
          - listitem:
            - paragraph: "/Commune de mise √† mort : \\\\d+ CHASSENARD/"
          - listitem:
            - paragraph: "/Date de mise √† mort : lundi 7 juillet \\\\d+/"
          - listitem:
            - paragraph: "/Heure de mise √† mort de la premi√®re carcasse de la fiche : \\\\d+:\\\\d+/"
        - paragraph: Acteurs
        - paragraph: Examinateur Initial
        - list:
          - listitem:
            - paragraph: Marie Martin
          - listitem:
            - paragraph: /\\d+/
          - listitem:
            - paragraph: examinateur@example.fr
          - listitem:
            - paragraph: /CFEI-\\d+-\\d+-\\d+/
          - listitem:
            - paragraph: /\\d+ Paris/
        - paragraph: Premier D√©tenteur
        - list:
          - listitem:
            - paragraph: Pierre Petit
          - listitem:
            - paragraph: /\\d+/
          - listitem:
            - paragraph: premier-detenteur@example.fr
          - listitem:
            - paragraph: /\\d+ Paris/
      `);
    await page.getByRole("heading", { name: "ü´µ Cette fiche vous a √©t√©" }).click();
    await expect(page.getByText("√âtape 2 sur")).toBeVisible();
    await expect(page.getByRole("heading", { name: "Fiche envoy√©e, pas encore" })).toBeVisible();
    await expect(page.getByText("√âtape suivante : Transport")).toBeVisible();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-004 Mise √†" }).click();
    await page.getByRole("listitem").filter({ hasText: "Fermer" }).getByRole("button").click();
    await page.getByRole("button", { name: "Pigeons (10) N¬∞ MM-001-003" }).click();
    await page.getByRole("heading", { name: "Pigeons (10) - N¬∞ MM-001-" }).click();
    await page.getByLabel("Pigeons (10) - N¬∞ MM-001-").getByTitle("Fermer").click();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-002 Mise √†" }).click();
    await expect(page.getByText("Unique - Abc√®s ou nodules")).toBeVisible();
    await page.getByLabel("Daim - N¬∞ MM-001-002").getByTitle("Fermer").click();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-001 Mise √†" }).click();
    await expect(page.getByText("Abc√®s ou nodules Unique -")).toBeVisible();
    await page.getByRole("listitem").filter({ hasText: "Fermer" }).getByRole("button").click();
    await page.getByRole("button", { name: "Je r√©ceptionne le gibier" }).click();
    await expect(page.getByRole("heading", { name: "R√©ception par un √©" })).toBeVisible();
    await expect(page.getByText("√âtape suivante : Inspection")).toBeVisible();
    await page.locator(".cursor-not-allowed").click();
    await expect(
      page.getByText("S√©lection du prochain destinataireProchain d√©tenteur des carcasses *Indiquez")
    ).toBeVisible();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-001 Mise √†" }).click();
    await page.getByText("Anomalies abats:Abc√®s ou").click();
    await page.getByLabel("Daim - N¬∞ MM-001-001Anomalies").getByText("Carcasse accept√©e").click();
    await expect(page.getByRole("button", { name: "Daim N¬∞ MM-001-001 Mise √†" })).toBeVisible();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-002 Mise √†" }).click();
    await page.getByText("Anomalies carcasse:Unique -").click();
    await page.getByLabel("Daim - N¬∞ MM-001-002Anomalies").getByText("Carcasse refus√©e").click();
    await page.getByRole("button", { name: "Viande √† √©volution anormale (" }).click();
    await page.getByRole("textbox", { name: "Votre commentaire Un" }).click();
    await page.getByRole("textbox", { name: "Votre commentaire Un" }).fill("Pas bon");
    await page.getByLabel("Daim - N¬∞ MM-001-002Anomalies").getByRole("button", { name: "Enregistrer" }).click();
    await expect(page.getByRole("button", { name: "Daim N¬∞ MM-001-002 Mise √†" })).toBeVisible();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-004 Mise √†" }).click();
    await page.getByLabel("Daim - N¬∞ MM-001-004").getByText("Carcasse manquante").click();
    await expect(page.getByRole("button", { name: "Daim N¬∞ MM-001-004 Mise √†" })).toBeVisible();
    await expect(page.getByText("Je prends en charge les")).toBeVisible();
    await expect(page.getByText("J'ai refus√© 1 carcasse.")).toBeVisible();
    await expect(page.getByText("J'ai signal√© 1 carcasse")).toBeVisible();
    await page
      .locator("#form_intermediaire_check_finished_at div")
      .filter({ hasText: "Je prends en charge les" })
      .click();
    await page.getByRole("button", { name: "Cliquez ici pour d√©finir" }).click();
    await page.getByRole("button", { name: "Enregistrer" }).click();
    await expect(page.getByText("Il manque le prochain d√©")).toBeVisible();
    await page.locator(".select-prochain-detenteur__input-container").click();
    await page.getByRole("option", { name: "Collecteur Pro 2 - 75000" }).click();
    await page.getByRole("button", { name: "Envoyer" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
    - heading "Attribution effectu√©e" [level=3]
    - paragraph: Collecteur Pro 2 a √©t√© notifi√©.
    `);
    await page.getByRole("link", { name: "Voir toutes mes fiches" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
    - link /ZACH-\\d+-QZ6E0-\\d+ En cours \\d+\\/\\d+\\/\\d+ chassenard √Ä renseigner \\d+ pigeons 3 daims fin de liste 2 carcasses refus√©es Transport vers un autre √©tablissement de traitement ZACH-\\d+-QZ6E0-\\d+/:
      - /url: /app/tableau-de-bord/fei/ZACH-20250707-QZ6E0-165242
      - paragraph: En cours
      - img
      - paragraph: chassenard
      - img
      - paragraph: √Ä renseigner
      - img
      - paragraph: /\\d+ pigeons/
      - paragraph: 3 daims
      - paragraph: fin de liste
      - img
      - paragraph: 2 carcasses refus√©es
      - paragraph: Transport vers un autre √©tablissement de traitement
    `);
  });

  test("Pas de stockage - Je transfert √† un autre ETG", async ({ page, context }) => {
    // const cdpSession = await context.newCDPSession(page);
    // // @ts-ignore
    // await cdpSession.send("Network.emulateNetworkConditions", NETWORK_PRESETS.PrettyGood);

    const feiId = "ZACH-20250707-QZ6E0-165242";
    await connectWith(page, "etg-1@example.fr");
    await expect(page).toHaveURL("http://localhost:3290/app/tableau-de-bord");
    await expect(page.getByText("Synchronisation en cours")).toBeVisible();
    await expect(page.getByText("Synchronisation en cours")).not.toBeVisible();
    await expect(page.getByRole("link", { name: feiId })).toBeVisible();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - link /ZACH-\\d+-QZ6E0-\\d+ √Ä compl√©ter \\d+\\/\\d+\\/\\d+ chassenard √Ä renseigner 4 daims fin de liste fin de liste ZACH-\\d+-QZ6E0-\\d+/:
        - /url: /app/tableau-de-bord/fei/ZACH-20250707-QZ6E0-165242
        - paragraph: √Ä compl√©ter
        - img
        - paragraph: chassenard
        - img
        - paragraph: √Ä renseigner
        - img
        - paragraph: 4 daims
        - paragraph: fin de liste
        - paragraph: fin de liste
      `);
    await page.getByRole("link", { name: feiId }).click();
    await page.locator("summary").filter({ hasText: "Donn√©es de chasse" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - group:
        - heading "Donn√©es de chasse" [level=3]
        - paragraph: Esp√®ces
        - paragraph: Daim, Pigeons
        - paragraph: √âpisodes cl√©s
        - list:
          - listitem:
            - paragraph: "/Commune de mise √† mort : \\\\d+ CHASSENARD/"
          - listitem:
            - paragraph: "/Date de mise √† mort : lundi 7 juillet \\\\d+/"
          - listitem:
            - paragraph: "/Heure de mise √† mort de la premi√®re carcasse de la fiche : \\\\d+:\\\\d+/"
        - paragraph: Acteurs
        - paragraph: Examinateur Initial
        - list:
          - listitem:
            - paragraph: Marie Martin
          - listitem:
            - paragraph: /\\d+/
          - listitem:
            - paragraph: examinateur@example.fr
          - listitem:
            - paragraph: /CFEI-\\d+-\\d+-\\d+/
          - listitem:
            - paragraph: /\\d+ Paris/
        - paragraph: Premier D√©tenteur
        - list:
          - listitem:
            - paragraph: Pierre Petit
          - listitem:
            - paragraph: /\\d+/
          - listitem:
            - paragraph: premier-detenteur@example.fr
          - listitem:
            - paragraph: /\\d+ Paris/
      `);
    await page.getByRole("heading", { name: "ü´µ Cette fiche vous a √©t√©" }).click();
    await expect(page.getByText("√âtape 2 sur")).toBeVisible();
    await expect(page.getByRole("heading", { name: "Fiche envoy√©e, pas encore" })).toBeVisible();
    await expect(page.getByText("√âtape suivante : Transport")).toBeVisible();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-004 Mise √†" }).click();
    await page.getByRole("listitem").filter({ hasText: "Fermer" }).getByRole("button").click();
    await page.getByRole("button", { name: "Pigeons (10) N¬∞ MM-001-003" }).click();
    await page.getByRole("heading", { name: "Pigeons (10) - N¬∞ MM-001-" }).click();
    await page.getByLabel("Pigeons (10) - N¬∞ MM-001-").getByTitle("Fermer").click();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-002 Mise √†" }).click();
    await expect(page.getByText("Unique - Abc√®s ou nodules")).toBeVisible();
    await page.getByLabel("Daim - N¬∞ MM-001-002").getByTitle("Fermer").click();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-001 Mise √†" }).click();
    await expect(page.getByText("Abc√®s ou nodules Unique -")).toBeVisible();
    await page.getByRole("listitem").filter({ hasText: "Fermer" }).getByRole("button").click();
    await page.getByRole("button", { name: "Je r√©ceptionne le gibier" }).click();
    await expect(page.getByRole("heading", { name: "R√©ception par un √©" })).toBeVisible();
    await expect(page.getByText("√âtape suivante : Inspection")).toBeVisible();
    await page.locator(".cursor-not-allowed").click();
    await expect(
      page.getByText("S√©lection du prochain destinataireProchain d√©tenteur des carcasses *Indiquez")
    ).toBeVisible();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-001 Mise √†" }).click();
    await page.getByText("Anomalies abats:Abc√®s ou").click();
    await page.getByLabel("Daim - N¬∞ MM-001-001Anomalies").getByText("Carcasse accept√©e").click();
    await expect(page.getByRole("button", { name: "Daim N¬∞ MM-001-001 Mise √†" })).toBeVisible();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-002 Mise √†" }).click();
    await page.getByText("Anomalies carcasse:Unique -").click();
    await page.getByLabel("Daim - N¬∞ MM-001-002Anomalies").getByText("Carcasse refus√©e").click();
    await page.getByRole("button", { name: "Viande √† √©volution anormale (" }).click();
    await page.getByRole("textbox", { name: "Votre commentaire Un" }).click();
    await page.getByRole("textbox", { name: "Votre commentaire Un" }).fill("Pas bon");
    await page.getByLabel("Daim - N¬∞ MM-001-002Anomalies").getByRole("button", { name: "Enregistrer" }).click();
    await expect(page.getByRole("button", { name: "Daim N¬∞ MM-001-002 Mise √†" })).toBeVisible();
    await page.getByRole("button", { name: "Daim N¬∞ MM-001-004 Mise √†" }).click();
    await page.getByLabel("Daim - N¬∞ MM-001-004").getByText("Carcasse manquante").click();
    await expect(page.getByRole("button", { name: "Daim N¬∞ MM-001-004 Mise √†" })).toBeVisible();
    await expect(page.getByText("Je prends en charge les")).toBeVisible();
    await expect(page.getByText("J'ai refus√© 1 carcasse.")).toBeVisible();
    await expect(page.getByText("J'ai signal√© 1 carcasse")).toBeVisible();
    await page
      .locator("#form_intermediaire_check_finished_at div")
      .filter({ hasText: "Je prends en charge les" })
      .click();
    await page.getByRole("button", { name: "Cliquez ici pour d√©finir" }).click();
    await page.getByRole("button", { name: "Enregistrer" }).click();
    await expect(page.getByText("Il manque le prochain d√©")).toBeVisible();
    await page.locator(".select-prochain-detenteur__input-container").click();
    await page.getByRole("option", { name: "ETG 2 - 75000 Paris (" }).click();
    await page.getByText("Je transporte les carcasses moi-m√™meN'oubliez pas de notifier le prochain d√©").click();
    await page.getByText("Le transport est r√©alis√© par").click();
    await page.getByText("Je transporte les carcasses moi-m√™meN'oubliez pas de notifier le prochain d√©").click();
    await page.getByRole("button", { name: "Envoyer" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - heading "Attribution effectu√©e" [level=3]
      - paragraph: ETG 2 a √©t√© notifi√©.
      `);
    await page.getByRole("link", { name: "Voir toutes mes fiches" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
    - link /ZACH-\\d+-QZ6E0-\\d+ En cours \\d+\\/\\d+\\/\\d+ chassenard √Ä renseigner \\d+ pigeons 3 daims fin de liste 2 carcasses refus√©es Fiche envoy√©e, pas encore trait√©e ZACH-\\d+-QZ6E0-\\d+/:
      - /url: /app/tableau-de-bord/fei/ZACH-20250707-QZ6E0-165242
      - paragraph: En cours
      - img
      - paragraph: chassenard
      - img
      - paragraph: √Ä renseigner
      - img
      - paragraph: /\\d+ pigeons/
      - paragraph: 3 daims
      - paragraph: fin de liste
      - img
      - paragraph: 2 carcasses refus√©es
      - paragraph: Fiche envoy√©e, pas encore trait√©e
    `);
    await page.getByRole("button", { name: "Mon profil" }).click();
    await page.getByRole("button", { name: "D√©connecter etg-1@example.fr" }).click();
    await connectWith(page, "etg-2@example.fr");
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
    - link /ZACH-\\d+-QZ6E0-\\d+ √Ä compl√©ter \\d+\\/\\d+\\/\\d+ chassenard √Ä renseigner \\d+ pigeons 3 daims fin de liste 2 carcasses refus√©es ZACH-\\d+-QZ6E0-\\d+/:
      - /url: /app/tableau-de-bord/fei/ZACH-20250707-QZ6E0-165242
      - paragraph: √Ä compl√©ter
      - img
      - paragraph: chassenard
      - img
      - paragraph: √Ä renseigner
      - img
      - paragraph: /\\d+ pigeons/
      - paragraph: 3 daims
      - paragraph: fin de liste
      - img
      - paragraph: 2 carcasses refus√©es
    `);
    await page.getByRole("link", { name: "ZACH-20250707-QZ6E0-165242 √Ä" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
    - heading "ü´µ Cette fiche a √©t√© attribu√©e √† votre soci√©t√©" [level=3]
    - paragraph:
      - text: En tant que Etablissement de Traitement du Gibier sauvage (ETG 2), vous pouvez prendre en charge cette fiche et les carcasses associ√©es.
      - button "Je r√©ceptionne le gibier"
      - text: Il y a une erreur ?
      - button "Transf√©rer la fiche"
      - button "Renvoyer la fiche √† l'exp√©diteur"
    `);
    await page.getByRole("button", { name: "Je r√©ceptionne le gibier" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
    - heading "R√©ception par un √©tablissement de traitement √âtape 4 sur 5" [level=2]
    - paragraph: "√âtape suivante : Inspection par le SVI"
    `);
    await expect(page.locator("ol")).toMatchAriaSnapshot(`
    - list:
      - listitem: Premier D√©tenteur
      - listitem:
        - button "ETG 1"
      - listitem:
        - button "ETG 2"
    `);
    await page.getByRole("button", { name: "Afficher les carcasses d√©j√†" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
      - 'button /Daim N¬∞ MM-\\d+-\\d+ Mise √† mort : \\d+\\/\\d+\\/\\d+ 1 anomalie, 1 commentaire refus√© par ETG 1/':
        - paragraph: Daim
        - paragraph: /N¬∞ MM-\\d+-\\d+/
        - paragraph: "/Mise √† mort : \\\\d+\\\\/\\\\d+\\\\/\\\\d+/"
        - paragraph: 1 anomalie, 1 commentaire
        - paragraph: refus√© par ETG 1
      `);
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
    - 'button /Daim N¬∞ MM-\\d+-\\d+ Mise √† mort : \\d+\\/\\d+\\/\\d+ Aucune anomalie manquant pour ETG 1/':
      - paragraph: Daim
      - paragraph: /N¬∞ MM-\\d+-\\d+/
      - paragraph: "/Mise √† mort : \\\\d+\\\\/\\\\d+\\\\/\\\\d+/"
      - paragraph: Aucune anomalie
      - paragraph: manquant pour ETG 1
    `);
    await page.locator("label").filter({ hasText: "Je prends en charge les" }).click();
    await page.getByRole("button", { name: "Cliquez ici pour d√©finir" }).click();
    await page.getByRole("button", { name: "Enregistrer" }).click();
    await page.locator(".select-prochain-detenteur__input-container").click();
    await page.getByRole("option", { name: "SVI 2 - 75000 Paris (Service" }).click();
    await page.getByRole("button", { name: "Envoyer" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
    - heading "Attribution effectu√©e" [level=3]
    - paragraph: SVI 2 a √©t√© notifi√©.
    `);

    await page.getByRole("link", { name: "Voir toutes mes fiches" }).click();
    await expect(page.locator("#content")).toMatchAriaSnapshot(`
    - link /ZACH-\\d+-QZ6E0-\\d+ En cours \\d+\\/\\d+\\/\\d+ chassenard √Ä renseigner \\d+ pigeons 3 daims fin de liste 2 carcasses refus√©es Inspection par le SVI ZACH-\\d+-QZ6E0-\\d+/:
      - /url: /app/tableau-de-bord/fei/ZACH-20250707-QZ6E0-165242
      - paragraph: En cours
      - img
      - paragraph: chassenard
      - img
      - paragraph: √Ä renseigner
      - img
      - paragraph: /\\d+ pigeons/
      - paragraph: 3 daims
      - paragraph: fin de liste
      - img
      - paragraph: 2 carcasses refus√©es
      - paragraph: Inspection par le SVI
    `);
  });
});
